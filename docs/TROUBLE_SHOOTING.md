# 기술적 난제 및 해결 과정 (TROUBLE_SHOOTING.md)

> 본 문서는 공지사항 관리 시스템 개발 중 직면한 기술적 제약 사항과 이를 해결하기 위한 설계적 의사결정 과정을 기록함.

---

## 1. 대용량 트래픽 대응: 자원 효율화 및 병목 방지

### **[문제] 대용량 첨부파일 처리 시 메모리 부족(OOM) 위험**
- 다중 사용자가 동시에 대용량 파일을 업로드하거나 다운로드할 경우, 서버 메모리에 바이트 배열을 적재하면 JVM Heap 영역에 과부하가 발생함.

### **[해결] Stream 기반 I/O 및 고성능 로깅**
- **Stream-through 방식**: `MultipartFile.getInputStream()`을 활용하여 메모리에 파일을 올리지 않고 디스크 I/O로 즉시 연결함.
- **8KB 버퍼 최적화**: OS 페이지 크기를 고려한 8KB 버퍼를 적용하여 컨텍스트 스위칭 비용을 최소화함.
- **Log4j2 도입**: 기본 Logback 대신 비동기 로깅에 강점이 있는 Log4j2를 사용하여, 대량의 트래픽 로그 기록 시 애플리케이션의 처리 지연을 방지함.

---

## 2. 보안: 파일 무결성 및 시스템 보호

### **[문제] 확장자 위조 및 경로 조작 공격**
- 단순 확장자 체크 방식은 실행 파일(exe)을 이미지(jpg)로 속여 업로드하는 공격에 취약하며, 파일명을 그대로 사용할 경우 Path Traversal 위험이 존재함.

### **[해결] Apache Tika 검증 및 파일명 해싱**
- **MIME Type 검증**: **Apache Tika** 라이브러리를 도입하여 파일의 실제 바이너리 내용을 분석, 허용된 미디어 타입만 승인함.
- **SHA-256 파일명 치환**: 실제 파일명을 `SHA-256` 해시값과 `UUID`로 암호화하여 저장함으로써 물리적 경로 노출 및 조작 가능성을 차단함.



---

## 3. 데이터 정합성: Hibernate를 이용한 동시성 제어

### **[문제] Lost Update (수정 내용 유실)**
- 여러 관리자가 동일한 공지사항을 동시에 수정할 때, 나중에 완료된 수정이 이전 수정을 덮어쓰는 정합성 오류가 발생할 수 있음.

### **[해결] @Version 기반 낙관적 락(Optimistic Lock)**
- 가산점 항목인 **Hibernate**의 기능을 활용하여 엔티티에 `@Version` 필드를 도입함.
- 데이터베이스에 무거운 락을 거는 대신, 수정 시점의 버전 체크를 통해 데이터 충돌을 방지하고 `409 Conflict` 예외를 반환하여 안전한 데이터 수정을 보장함.

---

## 4. 테스트 전략: 환경 독립성 및 유지보수성

### **[문제] 시점 의존성 로직 검증 및 테스트 복잡도**
- 공지 시작/종료일 검증은 실행 시점의 시간에 의존하므로 테스트 신뢰도가 떨어지며, 반복되는 설정으로 인해 테스트 코드의 가독성이 저하됨.

### **[해결] IntegrationTestSupport 및 Clock 추상화**
- **Test Infrastructure 구조화**: `@ActiveProfiles("test")`, `MockMvc`, `Clock` 설정 등을 **`IntegrationTestSupport` 추상 부모 클래스**에 집약하여 테스트 코드의 중복을 제거함.
- **Java Time Clock 주입**: `LocalDateTime.now()` 대신 주입된 `Clock`을 사용하여 테스트 시 특정 시점으로 시간을 고정, 엣지 케이스를 100% 검증함.



---

## 5. 검색 최적화: Querydsl을 통한 동적 쿼리

### **[문제] 복잡한 검색 조건의 안정적 처리**
- 제목, 내용, 등록일자 기간 등 다중 조건 검색 시 String 기반의 쿼리 작성은 오타에 취약하고 가독성이 떨어짐.

### **[해결] Querydsl 5.1 도입**
- **타입 안전한 쿼리**: 컴파일 타임에 오류를 잡을 수 있는 Querydsl을 도입하여 런타임 에러를 방지함.
- **BooleanExpression 활용**: 검색 조건을 메서드 단위로 분리하여 재사용성을 높이고, 가독성 높은 동적 쿼리 로직을 구현함.
- **보안 취약점(CVE-2024-49203) 선제적 대응**:
    - Querydsl의 `orderBy()`에 외부 입력값이 직접 노출될 때 발생할 수 있는 취약점을 인지하고 대응함.
    - **화이트리스트 방식**의 정렬 필드 검증 로직을 도입하고, 문자열의 Path 변환을 제한하며, 기본 정렬(ID 내림차순 등)을 강제 적용하여 악의적인 쿼리 조작 가능성을 차단함.
---